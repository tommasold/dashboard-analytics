<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analisi Dati</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center">📊 Dashboard di Analisi Dati</h2>

        <!-- Sezione Upload File -->
        <div class="card p-4 mt-4">
            <h4>📂 Carica un file CSV</h4>
            <input type="file" id="fileInput" class="form-control">
            <button id="uploadBtn" class="btn btn-primary mt-3">Carica</button>
        </div>

        <!-- Sezione Anteprima -->
        <div class="mt-4" id="previewSection" style="display: none;">
            <h4>🔍 Anteprima Dataset</h4>
            <table class="table table-striped mt-3">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <!-- Selezione colonna -->
        <div class="mt-4" id="columnSelection" style="display: none;">
            <h4>📌 Seleziona una colonna numerica</h4>
            <select id="columnDropdown" class="form-select"></select>
            <button id="generateChartBtn" class="btn btn-success mt-3">Genera Istogramma</button>
        </div>

        <!-- Sezione Statistiche -->
        <div class="mt-4" id="statsSection" style="display: none;">
            <h4>📈 Genera Statistiche</h4>
            <button id="generateStatsBtn" class="btn btn-info mt-3">Calcola Statistiche</button>
            <div class="mt-3" id="statsResults"></div>
        </div>

        <!-- Sezione Grafico -->
        <div class="mt-4" id="chartSection" style="display: none;">
            <h4>📉 Istogramma</h4>
            <img id="chart" class="img-fluid" alt="Grafico">
        </div>
    </div>

    <script>
        document.getElementById("uploadBtn").addEventListener("click", function() {
            let fileInput = document.getElementById("fileInput").files[0];
            if (!fileInput) {
                alert("Seleziona un file CSV!");
                return;
            }

            let formData = new FormData();
            formData.append("file", fileInput);

            fetch("/upload", { method: "POST", body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Errore: " + data.error);
                    return;
                }

                let filename = data.filename;
                let preview = data.preview;
                let columns = Object.keys(preview[0]);

                // Mostra anteprima dati
                document.getElementById("previewSection").style.display = "block";
                document.getElementById("tableHead").innerHTML = "<tr>" + columns.map(col => `<th>${col}</th>`).join("") + "</tr>";
                document.getElementById("tableBody").innerHTML = preview.map(row => "<tr>" + columns.map(col => `<td>${row[col]}</td>`).join("") + "</tr>").join("");

                // Mostra selezione colonna
                document.getElementById("columnSelection").style.display = "block";
                let columnDropdown = document.getElementById("columnDropdown");
                columnDropdown.innerHTML = "";
                columns.forEach(col => {
                    columnDropdown.innerHTML += `<option value="${col}">${col}</option>`;
                });

                // Mostra sezione statistiche
                document.getElementById("statsSection").style.display = "block";

                // Genera grafico al click
                document.getElementById("generateChartBtn").onclick = function() {
                    let selectedColumn = columnDropdown.value;
                    fetch(`/histogram/${filename}/${selectedColumn}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert("Errore: " + data.error);
                            return;
                        }
                        document.getElementById("chart").src = data.image;
                        document.getElementById("chartSection").style.display = "block";
                    });
                };

                // Genera statistiche al click
                document.getElementById("generateStatsBtn").onclick = function() {
                    let selectedColumn = columnDropdown.value;
                    fetch(`/stats/${filename}/${selectedColumn}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert("Errore: " + data.error);
                            return;
                        }

                        let statsHtml = "<ul>";
                        for (let key in data) {
                            statsHtml += `<li><b>${key.replace("_", " ")}:</b> ${data[key].toFixed(2)}</li>`;
                        }
                        statsHtml += "</ul>";

                        document.getElementById("statsResults").innerHTML = statsHtml;
                    });
                };
            })
            .catch(error => console.error("Errore:", error));
        });
    </script>

</body>
</html>
